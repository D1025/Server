                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               

uint __GetColor(int r,int g,int b,int a=0xFF)
{
	r=(((r)>(255))?(255):(((r)<(0))?(0):(r)));
	g=(((g)>(255))?(255):(((g)<(0))?(0):(g)));
	b=(((b)>(255))?(255):(((b)<(0))?(0):(b)));
	a=(((a)>(255))?(255):(((a)<(0))?(0):(a)));
	return(uint(((a)<<24)|(((r)&0xFF)<<16)|(((g)&0xFF)<<8)|((b)&0xFF)));
}                                                                                                             

import string GetCritterLexems(CritterCl&critter)from"lexems";
import string GetItemLexems(ItemCl&item)from"lexems";

import bool IsLexem(CritterCl&critter,string&lex)from"lexems";
import bool IsLexem(ItemCl&it,string&lex)from"lexems";
import bool IsLexem(string&lexems,string&lex)from"lexems";

import string GetLexem(CritterCl&critter,string&lex)from"lexems";
import string GetLexem(ItemCl&item,string&lex)from"lexems";
import string GetLexem(string&lexems,string&lex)from"lexems";                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 

shared class Sprite
{
	Sprite()
	{
		Id=0;
		Width=0;
		Height=0;
		FrmCount=0;
	}
	
	bool Load(string&name,int path)
	{
		if(name.length()>0)
		{
			Id=LoadSprite(name,path);
			Filename=name;
		}
		else
		Id=0;
		RefreshData();
		return Id!=0;
	}
	
	void LoadHash(uint nameHash,uint8 dir)
	{
		Id=LoadSprite(nameHash,dir);
		RefreshData();
	}
	
	void LoadByIni(string&iniKey,int path)
	{
		string@name=GetIfaceIniStr(iniKey);
		if(@name!=null&&name.length()>0)
		Id=LoadSprite(name,path);
		else
		Id=0;
		RefreshData();
	}
	
	void Draw(int x,int y)
	{
		if(Id!=0)
		DrawSprite(Id,-1,x,y,0);
	}
	
	private void RefreshData()
	{
		if(Id!=0)
		{
			Width=GetSpriteWidth(Id,0);
			Height=GetSpriteHeight(Id,0);
			FrmCount=GetSpriteCount(Id);
		}
		else
		{
			Width=0;
			Height=0;
			FrmCount=0;
			Filename="";
		}
	}
	
	uint Id;
	int Width;
	int Height;
	uint FrmCount;
	string Filename;
};  

import bool GMToolsAccess()from"client_gmtools";
import bool IsGMTEnabled()from"client_main"; 

import int stringReplaceText(string&s,string@f,string@t)from"config_file";
import int GUI_GetActiveMainScreen()from"client_gui";
import int GUI_GetActiveScreen()from"client_gui";

array<CritterCl@>crs;

void InitCritterOnHead()
{
	__ShowNpcNames=__ConfigShowNpcAwareness;
}

void DrawCritterOnHead()
{
	if(GUI_GetActiveMainScreen()!=(5))
	return;
	
	crs.resize(0);
	GetCritters(0,(0x0F),crs);
	
	int color_b=0;
	int color_g=0;
	int color_r=0;
	int hp_proc=0;
	string name;
	string hp;
	string inj;
	string crInjures;
	string mobDesc;
	string playerDesc;
	
	CritterCl@chosen=GetChosen();
	
	for(uint i=0,imax=crs.length();i<imax;i++)
	{
		
		uint dialog=crs[i].Stat[(104)];
		uint16 pid=crs[i].Pid;
		string head=(crs[i].IsPlayer()?crs[i].Name:" ");
		
		if(IsLexem(crs[i],"$@"))
		{
			head=GetLexem(crs[i],"$@");
			if(head.length()==0)
			head=" ";
			
			stringReplaceText(head,"|","");
			head=FormatTags(head,"");
		}
		
		if(IsGMTEnabled()&&GMToolsAccess())
		{
			array<string>gm;
			
			string id="<"+crs[i].Id+">";
			
			if((crs[i].IsPlayer()&&head!=crs[i].Name)||(crs[i].IsNpc()&&IsLexem(crs[i],"$@")))
			{
				if(crs[i].IsPlayer())
				gm.insertLast("Player: "+crs[i].Name);
				else if(crs[i].IsNpc())
				gm.insertLast("NPC: "+GetMsgStr((1),((dialog)!=0?100000+(dialog)*1000+100:((pid)*10))));
			}
			
			if(__ShowCritId)
			gm.insertLast("ID: "+crs[i].Id);
			
			if(crs[i].Param[(510)]>0)
			gm.insertLast("sneaked");
			
			if(gm.length()>0)
			{
				head+="|"+(uint((0xFF<<24)|(((0xFF)&0xFF)<<16)|(((0xFF)&0xFF)<<8)|((0xFF)&0xFF)))+" ";
				for(uint g=0,gLen=gm.length();g<gLen;g++)
				{
					head+="\n("+gm[g]+")";
				}
			}
		}
		
		if(head!=" ")
		{
			name="\n"+"|"+crs[i].NameColor+" "+head;
			crs[i].ContourColor=crs[i].ContourColor;
			
			if(crs[i].Stat[(106)]==chosen.Stat[(106)]&&crs[i].Id!=chosen.Id&&crs[i].Param[(510)]!=0)
			name=name+" (sneaked)";
		}
		else
		name=" ";  
		
		if(crs[i].IsPlayer()&&crs[i].Param[(187)]>0)
		{
			switch(crs[i].Param[(187)])
			{
				case 1:playerDesc="\n|"+(uint((0xFF<<24)|(((255)&0xFF)<<16)|(((255)&0xFF)<<8)|((255)&0xFF)))+" -TESTER-";break;
				case 2:playerDesc="\n|"+(uint((0xFF<<24)|(((255)&0xFF)<<16)|(((255)&0xFF)<<8)|((255)&0xFF)))+" -GAME MASTER-";break;
				case 3:playerDesc="\n|"+(uint((0xFF<<24)|(((255)&0xFF)<<16)|(((255)&0xFF)<<8)|((255)&0xFF)))+" -ADMINISTRATOR-";break;
			}
		}
		else
		playerDesc=""; 
		
		if(crs[i].IsPlayer()&&!__ConfigShowPlayerAwareness)
		{
			crs[i].NameOnHead=name;
			continue;
		}
		if((crs[i].IsLife()||crs[i].IsKnockout())&&crs[i].Param[(89)]==203&&crs[i].IsNpc())
		{
			switch(GetCurrentMapPid())
			{
				case(45):
				case(280):
				case(221):
				case(70):
				case(137):
				case(16):
				if(crs[i].Param[(187)]==1)mobDesc="\n|"+(uint((0xFF<<24)|(((200)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))+" Boss of Town Raiders";
				else mobDesc="\n|"+(uint((0xFF<<24)|(((200)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))+" Town Raider";
				break;
				default:
				if(crs[i].Param[(187)]==1)mobDesc="\n|"+(uint((0xFF<<24)|(((200)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))+" BOSS";
				else mobDesc="";
				break;
			}
		}
		else if(crs[i].Param[(89)]==205&&crs[i].IsNpc())
		{
			switch(GetCurrentMapPid())
			{
				case(45):
				case(280):
				case(221):
				case(70):
				case(137):
				case(16):
				mobDesc="\n|"+((uint((0xFF<<24)|(((0xAD)&0xFF)<<16)|(((0xAD)&0xFF)<<8)|((0xB9)&0xFF))))+" -Reward Giver-";
				break;
			}
		}
		else
		mobDesc="";
		
		if(crs[i].IsNpc()&&!__ConfigShowNpcAwareness)
		{
			crs[i].NameOnHead=name;
			continue;
		}
		
		if(crs[i].IsDead()==false)
		{
			if((@chosen!=null)&&__ConfigOnHeadAwareness==1)
			{
				color_g=(255*crs[i].Param[(72)])/crs[i].Param[(7)];
				hp_proc=crs[i].Param[(72)]*100/crs[i].Param[(7)];
				
				if(color_g<0)
				color_g=0;
				color_r=255-color_g;
				
				hp="|"+(uint((0xFF<<24)|(((color_r)&0xFF)<<16)|(((color_g)&0xFF)<<8)|((color_b)&0xFF)))+" "+crs[i].Param[(72)]+"/"+crs[i].Param[(7)];
			}
			else
			{
				string lifeRes="";
				switch(crs[i].Stat[(136)])
				{
					case 4:lifeRes="****";break;
					case 3:lifeRes="***";break;
					case 2:lifeRes="**";break;
					case 1:lifeRes="*";break;
				}
				
				hp="|"+(crs[i].Stat[(136)]<1?((uint((0xFF<<24)|(((0xAB)&0xFF)<<16)|(((0xAB)&0xFF)<<8)|((0xAB)&0xFF)))):(uint((0xFF<<24)|(((0xff-(0xff*crs[i].Stat[(136)])/5)&0xFF)<<16)|((((0xff*crs[i].Stat[(136)])/5)&0xFF)<<8)|((0)&0xFF))))+" "+lifeRes;
			}
			
			if((@chosen!=null)&&(crs[i].Damage[(502)]>0||crs[i].Damage[(503)]>0||crs[i].Damage[(504)]>0||crs[i].Damage[(505)]>0||crs[i].Damage[(506)]>0))
			{
				crInjures=" ";
				crInjures+=(crs[i].Damage[(502)]>0)?"E ":"";
				crInjures+=(crs[i].Damage[(503)]>0)?"RA ":"";
				crInjures+=(crs[i].Damage[(504)]>0)?"LA ":"";
				crInjures+=(crs[i].Damage[(505)]>0)?"RL ":"";
				crInjures+=(crs[i].Damage[(506)]>0)?"LL ":"";
				inj="|"+(uint((0xFF<<24)|(((200)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))+crInjures+"\n";
			}
			else
			inj="";
		}
		else
		{
			crs[i].NameOnHead=name;
			continue;
		} 
		
		crs[i].NameOnHead=inj+hp+mobDesc+playerDesc+name;
	}
}

void ChangeOnHeadAwarenessPlayer()
{
	__ConfigShowPlayerAwareness=!__ConfigShowPlayerAwareness;
}

void ChangeOnHeadAwarenessNPC()
{
	__ConfigShowNpcAwareness=!__ConfigShowNpcAwareness;
	__ShowNpcNames=__ConfigShowNpcAwareness;
}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       

import void WLog(string&type,string&message)from"debug";
import void WLog(string&type,string&message,int level)from"debug";
import void InitDebug()from"debug";   

bool ConsumedBlueprintForPid(Critter&player,uint pid)
{
	ProtoItem@proto=GetProtoItem(pid);
	return proto.NeedBlueprint==0||ConsumedBlueprint(player,proto.NeedBlueprint);
}

bool ConsumedBlueprint(Critter&player,uint pid)
{
	ProtoItem@proto=GetProtoItem(pid);
	if(proto.Type!=(20))
	return false;
	return(((player.Param[proto.Blueprint_Param])&((1<<proto.Blueprint_Id)))!=0);
}

void ConsumeBlueprint(Critter&player,Item&item)
{
	if(item.Proto.Type!=(20))
	return;
	((player.ParamBase[item.Proto.Blueprint_Param])=(player.ParamBase[item.Proto.Blueprint_Param])|((1<<item.Proto.Blueprint_Id)));
	do{if(item.GetCount()>(1)) item.SetCount(item.GetCount()-(1));else DeleteItem(item);}while(false);
}

array<array<uint16>>LevelBlueprints;
array<array<array<uint16>>>TypeLevelBlueprints;

void AddBlueprint(uint16 type,uint level,int pid)
{
	if(type>=TypeLevelBlueprints.length())
	TypeLevelBlueprints.resize(type+1);
	if(level>=TypeLevelBlueprints[type].length())
	TypeLevelBlueprints[type].resize(level+1);
	TypeLevelBlueprints[type][level].insertLast(pid);
} 

void InitBlueprints()
{
	Log("Init blueprints.");
	for(uint16 i=1;i<(30000);i++)
	{
		ProtoItem@proto=GetProtoItem(i);
		if(!(@proto!=null)||proto.Type!=(20))
		continue;
		if(proto.Blueprint_Param<0)
		continue;
		if(proto.Blueprint_Level>100)
		{
			Log("Proto "+i+" blueprint failed sanity check for level, ignored.");
			continue;
		}
		if(proto.Blueprint_Level>=LevelBlueprints.length())
		LevelBlueprints.resize(proto.Blueprint_Level+1);
		LevelBlueprints[proto.Blueprint_Level].insertLast(i);
	}
	for(uint i=0,j=LevelBlueprints.length();i<j;i++)
	Log("Found "+LevelBlueprints[i].length()+" blueprints of level "+i);
	
	for(uint16 i=1;i<(30000);i++)
	{
		ProtoItem@proto=GetProtoItem(i);
		if(!(@proto!=null)||proto.NeedBlueprint==0)
		continue;
		ProtoItem@bp=GetProtoItem(proto.NeedBlueprint);
		if(!(@bp!=null))
		{
			WLog("blueprints","invalid blueprint pid "+proto.NeedBlueprint+" for item pid "+i,20);
			continue;
		}
		AddBlueprint(proto.Type,bp.Blueprint_Level,bp.ProtoId);
	}
}

uint16 GetRandomBlueprintPid(uint8 level)
{
	
	if(level>2)
	level=Random(0,2);
	
	uint16 pid=0;
	if(level>=LevelBlueprints.length())
	return 0;
	array<uint16>@arr=LevelBlueprints[level];
	pid=(arr[Random(0,arr.length()-1)]);
	return pid;
}

uint16 GetRandomTypeBlueprintPid(int8 type,uint8 level)
{
	
	if(level>2)
	level=Random(0,2);
	
	if(type<0)
	return GetRandomBlueprintPid(level);
	uint16 pid=0;
	if(uint(type)>=TypeLevelBlueprints.length())
	return 0;
	if(level>=TypeLevelBlueprints[type].length())
	return 0;
	array<uint16>@arr=TypeLevelBlueprints[type][level];
	pid=(arr[Random(0,arr.length()-1)]);
	return pid;
}


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 

import string GetCritterLexems(Critter&critter)from"lexems";
import string GetItemLexems(Item&item)from"lexems";

import bool IsLexem(Critter&critter,string&lex)from"lexems";
import bool IsLexem(Item&it,string&lex)from"lexems";
import bool IsLexem(string&lexems,string&lex)from"lexems";

import string GetLexem(Critter&critter,string&lex)from"lexems";
import string GetLexem(Item&item,string&lex)from"lexems";
import string GetLexem(string&lexems,string&lex)from"lexems"; 

import void SetLexem(Critter&critter,string&lex,string&value)from"lexems";
import void SetLexem(Item&item,string&lex,string&value)from"lexems";
import string SetLexem(string&lexems,string&lex,string&value)from"lexems";

import void UnsetLexem(Critter&critter,string&lex)from"lexems";
import void UnsetLexem(Item&item,string&lex)from"lexems";
import string UnsetLexem(string&lexems,string&lex)from"lexems";                                     

import bool AddAchievement(Critter&cr,uint8 achievement)from"achievements";
import bool HaveAchievement(Critter&cr,uint8 achievement)from"achievements";                         

bool dbInitTable(string@,string@){return true;}
bool dbLog(string@,string@){return true;}                   

void InitDBLogs(){}

void LogExperience(Critter&cr,int amount){}
void LogExperience(Critter&cr,int amount,string@info){}
void LogExperience(Critter&cr,int amount,int skill){}
void LogExperience(Critter&cr,int amount,int skill,string@info){}
void LogExperience(Critter&cr,int amount,int skill,int param){}
void LogExperience(Critter&cr,int amount,int skill,string@info,int param){}
void LogQuestExperience(Critter&cr,int amount,string@info){}
void LogQuestExperience(Critter&cr,int amount,int skill,string@info){}
void LogAttack(Map@map,Critter&cr,Critter&target,ProtoItem&weapon,ProtoItem@ammo,uint8 aim,bool isBurst,uint ammoRound,uint weaponRound,bool isHit,bool isCritical,uint critfailFlags){}
void LogDamage(Map@map,Critter@attacker,Critter&target,Item@weapon,ProtoItem@ammo,uint8 aim,bool isBurst,uint damage,bool isCritical,uint eff,uint rounds){}
void LogGathering(Critter&,uint16,int){}               

import void InitLogs()from"logging";
import void FLog(uint logindex,string&text)from"logging";
import void ILog(string&section,string&text)from"logging";
import void GMLog(Critter&cr,string&text)from"logging";
import void CloseLogs()from"logging";
import uint AddLog(string&filename)from"logging";
import uint AddLog(string&filename,uint index)from"logging";                          

import Critter@GetMaster(Critter&follower)from"follower";
import void PerkUp(Critter&cr,uint perk,int from)from"perks";
import void PerkDown(Critter&cr,uint perk,int tolevel)from"perks";
import bool IsHumanoid(Critter@cr)from"utils";
import void VerboseExperience(Critter&cr,int xpDiff,int levelDiff)from"utils";
import void AddScore(Critter@cr,uint score,uint points)from"utils";

int getParamDialog_Reputation(Critter@master,Critter@slave,uint index)
{
	if(!(@master!=null))
	return 0;
	if((@slave!=null)&&master.Perk[(450)]!=0&&master.Stat[(71)]!=slave.Stat[(71)])
	return(((master.Param[index])>(250))?(master.Param[index]):(250));
	return master.Param[index];
}

void changedParam_Hp(Critter&cr,uint,int oldValue)
{
	int curHp=cr.StatBase[(72)];
	if(curHp<=0&&cr.IsLife())
	cr.StatBase[(72)]=1;
	if(cr.Perk[(461)]!=0)
	{
		if(curHp<__DeadHitPoints&&!cr.IsDead())
		cr.StatBase[(72)]=__DeadHitPoints+1;
	}
	else if(curHp<__DeadHitPoints&&!cr.IsDead())
	cr.StatBase[(72)]=__DeadHitPoints/2+1;
	int maxHp=cr.Stat[(7)];
	if(curHp>maxHp)
	{
		cr.StatBase[(72)]=maxHp;
		curHp=maxHp;
	} 
	
	if(cr.IsDead())
	cr.StatBase[(136)]=-1024;
	else if(curHp==maxHp)
	cr.StatBase[(136)]=4;
	else
	cr.StatBase[(136)]=(3*curHp)/maxHp+1;
	
}

void changedParam_Experience(Critter&cr,uint,int oldValue)
{
	int exp=cr.StatBase[(76)]-oldValue;
	int levelDiff=0; 
	
	if(exp>0)
	{
		exp+=9*exp;
		exp+=exp*((cr.Perk[(351)]+cr.Trait[(565)])*10)/100;
		LogExperience(cr,exp,-2);
		uint level=cr.Stat[(77)],oldLevel=level;  
		
		cr.StatBase[(76)]=oldValue+exp;
		
		if(level>=__LevelCap)
		{
			if((((cr.Mode[(534)]&((0x00000020)))!=0)))
			{
				VerboseExperience(cr,exp,0);
				return;
			}
		}
		
		int perkUp=(cr.Trait[(564)]!=0?4:3);
		while(true)
		{
			if(cr.StatBase[(76)]>=NextLevelNeedExp(cr))
			{
				level++;
				cr.StatBase[(77)]++;
				AddScore(cr,(21),1);   
				
				cr.StatBase[(78)]+=0;
				if(cr.Trait[(564)]!=0)
				cr.StatBase[(78)]+=0;
				
				cr.StatBase[(78)]+=cr.Perk[(319)]*0;    
				
				if(level<30)
				{
					cr.StatBase[(7)]+=cr.StatBase[(2)]/2;
					if((cr.StatBase[(2)]%2==1)&&cr.StatBase[(77)]%2==0)cr.StatBase[(7)]+=1;
					
					if((level%perkUp)==0&&(level<=__LevelCap))
					cr.StatBase[(79)]=1;
					
				}
			}
			else
			break;
		}
		levelDiff=level-oldLevel;
	}
	
	if((((cr.Mode[(534)]&((0x00000020)))!=0)))
	VerboseExperience(cr,exp,levelDiff);
}

void changedParam_Level(Critter&cr,uint a,int oldLevel)
{
	if(cr.IsPlayer())
	{
		if(cr.Stat[(77)]==int(__LevelCap)&&cr.GetScore((5))==0)
		AddAchievement(cr,(0));
		return;
	}
	
	if(!(((cr.Mode[(534)]&((0x00000020)))!=0)))
	return;
	else
	{
		Critter@master=GetMaster(cr);
		if((@master!=null)&&IsLexem(cr,"$name"))
		master.SayMsg((11),(3),(4099),"$name"+GetLexem(cr,"$name"));
	}
	
	if(cr.Param[(104)]==0)
	return;
	
	cr.SayMsg((9),(1),(1000000000+(cr.Param[(104)])*100000+((1))));
}

void changedParam_Perks(Critter&cr,uint perk,int oldValue)
{
	int curValue=cr.Param[perk];
	if(curValue>oldValue)
	for(int i=oldValue;i<curValue;i++)
	PerkUp(cr,perk,i);
	else if(curValue<oldValue)
	for(int i=oldValue-1;i>=curValue;i--)
	PerkDown(cr,perk,i);
	
	if(oldValue!=curValue&&cr.IsPlayer())
	FLog((12),cr.Name+"("+cr.Id+") changing perk "+perk+" value: "+oldValue+" -> "+curValue);
}

void changedParam_Hide(Critter&cr,uint,int oldValue)
{
	cr.RefreshVisible();
}

void changedParam_FastShot(Critter&cr,uint,int oldValue)
{
	cr.ModeBase[(538)]=(cr.Trait[(557)]!=0?1:0);
} 

int NextLevelNeedExp(Critter&cr)
{
	int level=cr.Stat[(77)];
	return((level)*((level)+1)/2)*1000;
}                                      

int GetMaxLife(Critter&cr)
{
	int val=cr.StatBase[(7)]+cr.StatBase[(39)]+cr.StatBase[(0)]+cr.StatBase[(2)]*2;
	return(((val)>(9999))?(9999):(((val)<(1))?(1):(val)));
}         

void CritterGenerate(Critter&cr)    

{
	if(cr.ParamBase[(77)]==0)
	cr.ParamBase[(77)]=1;
	
	if(cr.ParamBase[(552)]!=0)
	cr.ParamBase[(5)]+=1;
	if(cr.ParamBase[(551)]!=0)
	cr.ParamBase[(0)]+=4;                  
	
	cr.ParamBase[(200)]+=100+10*cr.ParamBase[(5)];
	cr.ParamBase[(201)]+=100+10*cr.ParamBase[(2)];
	cr.ParamBase[(202)]+=100+10*cr.ParamBase[(4)];
	cr.ParamBase[(203)]+=100+10*cr.ParamBase[(0)];
	cr.ParamBase[(204)]+=100+10*cr.ParamBase[(1)];
	cr.ParamBase[(205)]+=100+10*cr.ParamBase[(5)];
	cr.ParamBase[(206)]+=100+10*cr.ParamBase[(4)];
	cr.ParamBase[(207)]+=100+10*cr.ParamBase[(4)];
	cr.ParamBase[(208)]+=100+10*cr.ParamBase[(5)];
	cr.ParamBase[(209)]+=100+10*cr.ParamBase[(4)];
	cr.ParamBase[(210)]+=100+5*(cr.ParamBase[(5)]+cr.ParamBase[(6)]);
	cr.ParamBase[(211)]+=100+10*cr.ParamBase[(5)];
	cr.ParamBase[(212)]+=100+10*cr.ParamBase[(4)];
	cr.ParamBase[(213)]+=100+10*cr.ParamBase[(4)];
	cr.ParamBase[(214)]+=100+10*cr.ParamBase[(3)];
	cr.ParamBase[(215)]+=100+10*cr.ParamBase[(3)];
	cr.ParamBase[(216)]+=100+10*cr.ParamBase[(3)];
	cr.ParamBase[(217)]+=100+5*(cr.ParamBase[(3)]+cr.ParamBase[(4)]+cr.ParamBase[(6)]);
	
	if(cr.ParamBase[(226)]!=0)
	cr.ParamBase[cr.ParamBase[(226)]]+=50;
	if(cr.ParamBase[(227)]!=0)
	cr.ParamBase[cr.ParamBase[(227)]]+=50;
	if(cr.ParamBase[(228)]!=0)
	cr.ParamBase[cr.ParamBase[(228)]]+=50;
	
	if(cr.ParamBase[(555)]!=0)
	{
		
		for(uint i=(23);i<=(29);i++)
		cr.ParamBase[i]-=10;
	}
	if(cr.ParamBase[(554)]!=0)
	cr.ParamBase[(14)]+=10;
	if(cr.ParamBase[(557)]!=0)
	cr.ParamBase[(538)]=1;
	if(cr.ParamBase[(563)]!=0)
	cr.ParamBase[(4)]-=1;                         
	
	cr.ParamBase[(72)]=cr.ParamBase[(7)];
	cr.ParamBase[(75)]=cr.ParamBase[(8)]*100;
	
	cr.ParamBase[(136)]=4;
	
	if(IsHumanoid(cr))
	{
		cr.StatBase[(7)]=150-cr.StatBase[(2)]*2-cr.StatBase[(0)]+cr.StatBase[(2)]/2;
		cr.StatBase[(8)]=10-cr.StatBase[(5)]/2;
		cr.StatBase[(9)]=cr.StatBase[(5)]-3*cr.StatBase[(5)];
		cr.StatBase[(14)]=-cr.StatBase[(6)];
	}
	
}                                          

void NpcProcessLevel(Critter&npc)
{
	int level=npc.Stat[(77)];
	if(level==0)
	return;
	level--;
	npc.StatBase[(7)]+=(GetMaxLife(npc)*level)/20;
	npc.StatBase[(72)]=npc.Stat[(7)];
	for(uint i=(__SkillBegin);i<=(__SkillEnd);i++)
	npc.SkillBase[i]+=(npc.Skill[i]*level)/20;
}

void NpcSetLevel(Critter&npc,int level)
{
	int oldlevel=npc.Stat[(77)];
	npc.StatBase[(77)]=level;
	level-=oldlevel;
	npc.StatBase[(7)]+=(2+(npc.StatBase[(2)]>>1))*level;
	npc.StatBase[(72)]=npc.Stat[(7)];
	for(uint i=(__SkillBegin);i<=(__SkillEnd);i++)
	npc.SkillBase[i]+=5*level;
}  

uint CheckPlayerName(const string&name)
{
	
	if(name.length()<__MinNameLength||name.length()>__MaxNameLength)
	return(1009); 
	
	string allLetters=__ValidNameLettersCommon+__ValidNameLettersCulture1+__ValidNameLettersCulture2;
	for(uint i=0,j=name.length();i<j;i++)
	if(findFirst(allLetters,name[i])==-1)
	return(1036); 
	
	if(name[0]==" "||name[-1]==" ")
	return(1032);
	for(int i=0,j=name.length()-1;i<j;i++)
	if(name[i]==" "&&name[i+1]==" ")
	return(1033); 
	
	uint letters1=0;
	uint letters2=0;
	for(int i=0,j=name.length()-1;i<j;i++)
	{
		if(findFirst(__ValidNameLettersCulture1,name[i])!=-1)
		letters1++;
		else if(findFirst(__ValidNameLettersCulture2,name[i])!=-1)
		letters2++;
	}
	if(letters1>0&&letters2>0)
	return(1030); 
	
	if((letters1+letters2)*100/name.length()<70)
	return(1031); 
	
	return 0;
}
